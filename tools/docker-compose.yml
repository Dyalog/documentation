services:
  mkdocs-server:
    build:
      context: .
      dockerfile: mkdocs/Dockerfile
    volumes:
      - ${DOCS_DIR}:/docs
      - ${ASSETS_DIR}:/docs/docs/documentation-assets
    ports:
      - "8000:8000"
    environment:
      - DOCS_DIR=${DOCS_DIR}
      - ASSETS_DIR=${ASSETS_DIR}
    working_dir: /docs
    command: mkdocs serve --dev-addr 0.0.0.0:8000 --dirty

  utils:
    build:
      context: .
      dockerfile: utils/Dockerfile
    volumes:
      - ${DOCS_DIR}:/docs
      - ${ASSETS_DIR}:/docs/docs/documentation-assets
      - ./utils:/utils
    environment:
      - DOCS_DIR=${DOCS_DIR}
    working_dir: /docs
    # Default command can be overridden when running
    command: python --version

  docs-nginx:
    build:
      context: ${DOCS_DIR}
      dockerfile: tools/nginx/Dockerfile
    ports:
      - "8080:8080"
    volumes:
      # Mount source as READ-ONLY so container can't write to host
      - ${DOCS_DIR}:/docs-source:ro
      - ${ASSETS_DIR}:/docs-source/docs/documentation-assets:ro
    environment:
      - DOCS_DIR=${DOCS_DIR}
      - ASSETS_DIR=${ASSETS_DIR}
    # This service builds the site when started and serves it via nginx
    # Source is mounted read-only at /docs-source
    # All git operations and builds happen in /docs (inside container only)
    # Access at http://localhost:8080